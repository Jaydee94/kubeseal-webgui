name: Release Helm-Chart

on:
  push:
    tags:
      - '*'

permissions:
  contents: read
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package and Push Helm Chart
        run: |
          # Get the version from the tag (remove v prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Processing version $VERSION"
          
          # Update values.yaml inside the runner so the packaged chart has the right defaults
          yq -i ".ui.image.tag = \"$VERSION\"" chart/kubeseal-webgui/values.yaml
          yq -i ".api.image.tag = \"$VERSION\"" chart/kubeseal-webgui/values.yaml

          # Package the chart with the explicit version
          # This automatically updates version and appVersion in the packaged Chart.yaml
          helm package chart/kubeseal-webgui --version "$VERSION" --app-version "$VERSION"
          
          # Lowercase the repository name for OCI registry compatibility
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Push the packaged chart
          helm push kubeseal-webgui-$VERSION.tgz oci://ghcr.io/$REPO_NAME/charts
