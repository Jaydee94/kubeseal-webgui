name: Release Helm-Chart

on:
  push:
    tags:
      - '*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package and Push Helm Chart
        run: |
          # Get the application version from the tag (remove refs/tags/ and optional v prefix)
          APP_VERSION=${GITHUB_REF#refs/tags/}
          APP_VERSION=${APP_VERSION#v}
          echo "Application version: $APP_VERSION"
          
          # Read current chart version from Chart.yaml
          CURRENT_CHART_VERSION=$(yq '.version' chart/kubeseal-webgui/Chart.yaml)
          echo "Current chart version: $CURRENT_CHART_VERSION"
          
          # Bump patch version of chart
          CHART_VERSION=$(echo "$CURRENT_CHART_VERSION" | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "New chart version: $CHART_VERSION"
          
          # Update Chart.yaml with new chart version and appVersion
          yq -i ".version = \"$CHART_VERSION\"" chart/kubeseal-webgui/Chart.yaml
          yq -i ".appVersion = \"$APP_VERSION\"" chart/kubeseal-webgui/Chart.yaml
          
          # Update values.yaml with application version for image tags
          yq -i ".ui.image.tag = \"$APP_VERSION\"" chart/kubeseal-webgui/values.yaml
          yq -i ".api.image.tag = \"$APP_VERSION\"" chart/kubeseal-webgui/values.yaml

          # Package the chart with the bumped chart version
          helm package chart/kubeseal-webgui --version "$CHART_VERSION" --app-version "$APP_VERSION"
          
          # Lowercase the repository name for OCI registry compatibility
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Push the packaged chart
          helm push kubeseal-webgui-$CHART_VERSION.tgz oci://ghcr.io/$REPO_NAME/charts

      - name: Commit Version Updates
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add the updated files
          git add chart/kubeseal-webgui/Chart.yaml chart/kubeseal-webgui/values.yaml
          
          # Commit with a clear message
          git commit -m "chore: bump chart version to $(yq '.version' chart/kubeseal-webgui/Chart.yaml) for app version $(yq '.appVersion' chart/kubeseal-webgui/Chart.yaml) [skip ci]" || echo "No changes to commit"
          
          # Push to master
          git push origin HEAD:master
